<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">delta</span>,<span class="var type1" id="S3T1U4">delta_filt</span>,<span class="var type1" id="S4T1U5">r_w</span>,<span class="var type1" id="S5T1U6">stillness</span>] = getDelta_1D(<span class="var type1" id="S6T2U9">meta</span>,<span class="var type1" id="S7T4U10">data1</span>,<span class="var type1" id="S8T4U11">data2</span>,<span class="var type1" id="S9T6U12">joint</span>,<span class="var type1" id="S10T7U13">varargin</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%% Params</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="mxinfo " id="T3:U10"><span class="var type1" id="S11T3U16">gnSteps</span>         = <span class="mxinfo " id="T3:U12">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="mxinfo " id="T3:U13"><span class="var type1" id="S12T3U20">window_time</span>     = <span class="mxinfo " id="T3:U15">10</span></span>; <span class="comment">% s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="mxinfo " id="T3:U16"><span class="var type1" id="S13T3U24">data_rate</span>       = <span class="mxinfo " id="T3:U18">5</span></span>; <span class="comment">% Hz</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T3:U19"><span class="var type1" id="S14T3U28">estimation_rate</span> = <span class="mxinfo " id="T3:U21">1</span></span>; <span class="comment">%Hz</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo " id="T3:U22"><span class="var type1" id="S15T3U32">tauDelta</span>        = <span class="mxinfo " id="T3:U24">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo " id="T3:U25"><span class="var type1" id="S16T3U36">tauBias</span>         = <span class="mxinfo " id="T3:U27">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T3:U28"><span class="var type1" id="S17T3U40">minWeight</span>       = <span class="mxinfo " id="T3:U30">0.45</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo " id="T8:U31"><span class="var type1" id="S18T8U44">alignment</span>       = <span class="mxinfo " id="T8:U33"><span class="string">'backward'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo " id="T8:U34"><span class="var type1" id="S19T8U48">constraint</span>      = <span class="mxinfo " id="T8:U36"><span class="string">'euler_1d'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo " id="T9:U37"><span class="var type1" id="S20T9U52">enable_stillness</span> = <span class="mxinfo " id="T9:U39">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="keyword">if</span>(nargin&gt;4)</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">    <span class="var type0" id="S23T0U64">est_settings</span>        = <span class="var type0" id="S10T0U66">varargin</span>{1};</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">    <span class="var type0" id="S12T0U70">window_time</span>         = <span class="var type0" id="S23T0U73">est_settings</span>.D1.window_time;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line">    <span class="var type0" id="S14T0U78">estimation_rate</span>     = <span class="var type0" id="S23T0U81">est_settings</span>.D1.estimation_rate;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line">    <span class="var type0" id="S13T0U86">data_rate</span>           = <span class="var type0" id="S23T0U89">est_settings</span>.D1.data_rate;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line">    <span class="var type0" id="S15T0U94">tauDelta</span>            = <span class="var type0" id="S23T0U97">est_settings</span>.D1.tauDelta;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line">    <span class="var type0" id="S16T0U102">tauBias</span>             = <span class="var type0" id="S23T0U105">est_settings</span>.D1.tauBias;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line">    <span class="var type0" id="S17T0U110">minWeight</span>           = <span class="var type0" id="S23T0U113">est_settings</span>.D1.minWeight;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line">    <span class="var type0" id="S18T0U118">alignment</span>           = <span class="var type0" id="S23T0U121">est_settings</span>.D1.alignment;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">    <span class="var type0" id="S19T0U126">constraint</span>          = <span class="var type0" id="S23T0U129">est_settings</span>.D1.constraint;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="var type0" id="S20T0U134">enable_stillness</span>    = <span class="var type0" id="S23T0U137">est_settings</span>.D1.enable_stillness;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T3:U40"><span class="var type1" id="S24T3U142">sampling_time</span> = <span class="mxinfo " id="T3:U42"><span class="mxinfo " id="T3:U43">1.0</span>/double(<span class="mxinfo " id="T3:U44"><span class="var type1" id="S6T2U148">meta</span>.rate</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T3:U46"><span class="var type1" id="S26T3U152">sample_rate</span> = <span class="mxinfo " id="T3:U48"><span class="mxinfo " id="T3:U49">1</span>/<span class="var type1" id="S24T3U155">sampling_time</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T3:U51"><span class="var type1" id="S27T3U158">window_steps</span> = <span class="mxinfo " id="T3:U53"><span class="var type1" id="S12T3U160">window_time</span> * <span class="var type1" id="S26T3U161">sample_rate</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo " id="T3:U56"><span class="var type1" id="S28T3U164">estimation_steps</span> = <span class="mxinfo " id="T3:U58"><span class="mxinfo " id="T3:U59"><span class="mxinfo " id="T3:U60">1</span>/<span class="var type1" id="S14T3U168">estimation_rate</span></span> * <span class="var type1" id="S26T3U169">sample_rate</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T3:U63"><span class="var type1" id="S29T3U172">data_steps</span> = <span class="mxinfo " id="T3:U65"><span class="mxinfo " id="T3:U66"><span class="mxinfo " id="T3:U67">1</span>/<span class="var type1" id="S13T3U176">data_rate</span></span> * <span class="var type1" id="S26T3U177">sample_rate</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% stillness settings</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T3:U70"><span class="var type1" id="S30T3U180">stillness_time</span> = <span class="mxinfo " id="T3:U72">3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="mxinfo " id="T3:U73"><span class="var type1" id="S31T3U184">still_threshold</span> = <span class="mxinfo " id="T3:U75"><span class="fcn" id="F8N3:B186">deg2rad</span>(<span class="mxinfo " id="T3:U76">4</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="mxinfo " id="T3:U77"><span class="var type1" id="S33T3U190">NStill</span> = <span class="mxinfo " id="T3:U79"><span class="var type1" id="S30T3U192">stillness_time</span> * <span class="var type1" id="S26T3U193">sample_rate</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">%% Coordinate System</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="keyword">if</span>(size(<span class="var type1" id="S9T6U200">joint</span>,1) &gt; size(<span class="var type1" id="S9T6U204">joint</span>,2))</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">    <span class="var type0" id="S9T0U208">joint</span> = <span class="var type0" id="S9T0U210">joint</span>';</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="mxinfo " id="T6:U84"><span class="var type1" id="S35T6U213">j</span> = <span class="mxinfo " id="T6:U86"><span class="var type1" id="S9T6U215">joint</span>(<span class="mxinfo " id="T10:U88">1</span>,<span class="mxinfo " id="T11:U89">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T6:U90"><span class="var type1" id="S36T6U220">j_long</span> = <span class="mxinfo " id="T6:U92">[1 0 0]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%% Preparation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T3:U93"><span class="var type1" id="S37T3U228">steps</span>       = <span class="mxinfo " id="T3:U95">length(<span class="mxinfo " id="T1:U96"><span class="var type1" id="S7T4U232">data1</span>.time</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo " id="T3:U98"><span class="var type1" id="S39T3U236">last_delta_w</span> = <span class="mxinfo " id="T3:U100">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="keyword">switch</span> <span class="var type1" id="S18T8U239">alignment</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'backward'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">        <span class="mxinfo " id="T12:U102"><span class="var type1" id="S40T12U244">starts</span> = <span class="mxinfo " id="T12:U104"><span class="mxinfo " id="T3:U105"><span class="var type1" id="S27T3U248">window_steps</span>+<span class="mxinfo " id="T3:U107">1</span></span>:<span class="var type1" id="S28T3U250">estimation_steps</span>:(<span class="mxinfo " id="T3:U109"><span class="var type1" id="S37T3U253">steps</span>-<span class="mxinfo " id="T3:U111">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'center'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">        <span class="var type0" id="S40T0U259">starts</span> = <span class="var type0" id="S27T0U264">window_steps</span>/2+1:<span class="var type0" id="S28T0U267">estimation_steps</span>:(<span class="var type0" id="S37T0U270">steps</span>-<span class="var type0" id="S27T0U272">window_steps</span>/2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'forward'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">        <span class="var type0" id="S40T0U278">starts</span> = 2:<span class="var type0" id="S28T0U282">estimation_steps</span>:(<span class="var type0" id="S37T0U285">steps</span>-<span class="var type0" id="S27T0U286">window_steps</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T3:U112"><span class="var type1" id="S41T3U289">regular_estimation_start</span> = <span class="mxinfo " id="T3:U114"><span class="var type1" id="S40T12U291">starts</span>(<span class="mxinfo " id="T3:U116">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T12:U117"><span class="var type1" id="S40T12U295">starts</span> = <span class="mxinfo " id="T12:U119">[<span class="mxinfo " id="T12:U120">1:<span class="var type1" id="S29T3U301">data_steps</span>:(<span class="mxinfo " id="T3:U122"><span class="mxinfo " id="T3:U123"><span class="var type1" id="S40T12U305">starts</span>(<span class="mxinfo " id="T3:U125">1</span>)</span>-<span class="var type1" id="S29T3U307">data_steps</span></span>)</span>,<span class="var type1" id="S40T12U308">starts</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T3:U128"><span class="var type1" id="S42T3U311">estimations</span> = <span class="mxinfo " id="T3:U130">length(<span class="var type1" id="S40T12U314">starts</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T12:U132"><span class="var type1" id="S5T12U317">stillness</span> = <span class="mxinfo " id="T12:U134">zeros(<span class="mxinfo " id="T3:U135">1</span>,<span class="var type1" id="S42T3U321">estimations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="mxinfo " id="T12:U137"><span class="var type1" id="S4T12U324">r_w</span> = <span class="mxinfo " id="T12:U139">zeros(<span class="mxinfo " id="T3:U140">1</span>,<span class="var type1" id="S42T3U328">estimations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo " id="T12:U142"><span class="var type1" id="S44T12U331">r_w_mod</span> = <span class="mxinfo " id="T12:U144">zeros(<span class="mxinfo " id="T3:U145">1</span>,<span class="var type1" id="S42T3U335">estimations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T12:U147"><span class="var type1" id="S45T12U338">tauDelta_mod</span> = <span class="mxinfo " id="T12:U149">zeros(<span class="mxinfo " id="T3:U150">1</span>,<span class="var type1" id="S42T3U342">estimations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="mxinfo " id="T12:U152"><span class="var type1" id="S46T12U345">tauBias_mod</span> = <span class="mxinfo " id="T12:U154">zeros(<span class="mxinfo " id="T3:U155">1</span>,<span class="var type1" id="S42T3U349">estimations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="mxinfo " id="T12:U157"><span class="var type1" id="S2T12U352">delta</span> = <span class="mxinfo " id="T12:U159">zeros(<span class="mxinfo " id="T3:U160">1</span>,<span class="var type1" id="S42T3U356">estimations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S47T3U359">k</span> = <span class="mxinfo " id="T3:U163">1</span>:<span class="var type1" id="S42T3U362">estimations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="comment">%% Basic estimation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="mxinfo " id="T3:U165"><span class="var type1" id="S48T3U365">index</span> = <span class="mxinfo " id="T3:U167"><span class="var type1" id="S40T12U367">starts</span>(<span class="var type1" id="S47T3U368">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="comment">% calculate the start and end index of the chosen alignment</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T9:U170"><span class="var type1" id="S48T3U372">index</span> &lt; <span class="var type1" id="S41T3U373">regular_estimation_start</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">        <span class="mxinfo " id="T9:U173"><span class="var type1" id="S49T9U376">startup_estimation</span> = <span class="mxinfo " id="T9:U175">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">        <span class="mxinfo " id="T3:U176"><span class="var type1" id="S51T3U381">startIndex</span> = <span class="mxinfo " id="T3:U178">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">        <span class="mxinfo " id="T3:U179"><span class="var type1" id="S52T3U385">endIndex</span> = <span class="var type1" id="S48T3U386">index</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="mxinfo " id="T9:U182"><span class="var type1" id="S49T9U390">startup_estimation</span> = <span class="mxinfo " id="T9:U184">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">        <span class="keyword">switch</span> <span class="var type1" id="S18T8U394">alignment</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">            <span class="keyword">case</span> <span class="string">'center'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">                <span class="var type0" id="S51T0U399">startIndex</span> = <span class="var type0" id="S48T0U401">index</span> - <span class="var type0" id="S27T0U403">window_steps</span>/2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">                <span class="var type0" id="S52T0U407">endIndex</span> = <span class="var type0" id="S48T0U409">index</span> +<span class="var type0" id="S27T0U411">window_steps</span>/2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">            <span class="keyword">case</span> <span class="string">'forward'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">                <span class="var type0" id="S51T0U417">startIndex</span> = <span class="var type0" id="S48T0U418">index</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">                <span class="var type0" id="S52T0U421">endIndex</span> = <span class="var type0" id="S48T0U423">index</span> + <span class="var type0" id="S27T0U424">window_steps</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">            <span class="keyword">case</span> <span class="string">'backward'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">                <span class="mxinfo " id="T3:U186"><span class="var type1" id="S51T3U429">startIndex</span> = <span class="mxinfo " id="T3:U188"><span class="var type1" id="S48T3U431">index</span>-<span class="var type1" id="S27T3U432">window_steps</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">                <span class="mxinfo " id="T3:U191"><span class="var type1" id="S52T3U435">endIndex</span> = <span class="var type1" id="S48T3U436">index</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="comment">% check if the sensors are at rest</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">    <span class="keyword">if</span>(<span class="var type1" id="S20T9U444">enable_stillness</span> &amp;&amp; <span class="var type0" id="S49T0U446">startup_estimation</span> == false &amp;&amp; <span class="var type0" id="S48T0U450">index</span>&gt;<span class="var type0" id="S33T0U451">NStill</span> &amp;&amp; mean(vecnorm2(<span class="var type0" id="S7T0U459">data1</span>.gyr(<span class="var type0" id="S48T0U463">index</span>-<span class="var type0" id="S33T0U464">NStill</span>:<span class="var type0" id="S48T0U465">index</span>,:))) &lt; <span class="var type0" id="S31T0U467">still_threshold</span> &amp;&amp; mean(vecnorm2(<span class="var type0" id="S8T0U475">data2</span>.gyr(<span class="var type0" id="S48T0U479">index</span>-<span class="var type0" id="S33T0U480">NStill</span>:<span class="var type0" id="S48T0U481">index</span>,:))) &lt; <span class="var type0" id="S31T0U483">still_threshold</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">        <span class="var type0" id="S55T0U486">state</span> = <span class="string">'stillness'</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">        <span class="keyword">if</span>(strcmp(<span class="var type0" id="S55T0U494">state</span>,<span class="var type0" id="S57T0U495">last_state</span>) == false) <span class="comment">% state changed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">            <span class="var type0" id="S58T0U500">delta_still</span> = <span class="var type0" id="S39T0U501">last_delta_w</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">            <span class="var type0" id="S59T0U504">qb2b1_ref</span> = quaternionMultiply(quaternionMultiply(quaternionInvert(<span class="var type0" id="S7T0U513">data1</span>.quat(<span class="var type0" id="S48T0U515">index</span>,:)),getQuat(<span class="var type0" id="S58T0U519">delta_still</span>,[0 0 1])),<span class="var type0" id="S8T0U527">data2</span>.quat(<span class="var type0" id="S48T0U529">index</span>,:));</span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">        <span class="var type0" id="S63T0U533">q_e2_e1</span> = quaternionMultiply(quaternionMultiply(<span class="var type0" id="S7T0U540">data1</span>.quat(<span class="var type0" id="S48T0U542">index</span>,:),<span class="var type0" id="S59T0U544">qb2b1_ref</span>),quaternionInvert(<span class="var type0" id="S8T0U549">data2</span>.quat(<span class="var type0" id="S48T0U551">index</span>,:)));</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        <span class="var type0" id="S64T0U555">q_rel</span> = relativeQuaternion(getQuat(<span class="var type0" id="S58T0U560">delta_still</span>,[0 0 1]),<span class="var type0" id="S63T0U566">q_e2_e1</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">        <span class="var type0" id="S66T0U569">delta_inc</span> = 2*atan2(dot(<span class="var type0" id="S64T0U577">q_rel</span>(2:4),[0,0,1]),<span class="var type0" id="S64T0U587">q_rel</span>(1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">        <span class="var type0" id="S69T0U591">delta_w</span> = <span class="var type0" id="S58T0U593">delta_still</span>+ <span class="var type0" id="S66T0U594">delta_inc</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">        <span class="var type0" id="S57T0U597">last_state</span> = <span class="string">'stillness'</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">        <span class="var type0" id="S5T0U602">stillness</span>(<span class="var type0" id="S47T0U603">k</span>) = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">        <span class="mxinfo " id="T13:U195"><span class="var type1" id="S55T13U608">state</span>= <span class="mxinfo " id="T13:U197"><span class="string">'active'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">        <span class="mxinfo " id="T13:U198"><span class="var type1" id="S57T13U612">last_state</span> = <span class="mxinfo " id="T13:U200"><span class="string">'active'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">        <span class="mxinfo " id="T3:U201"><span class="mxinfo " id="T3:U202"><span class="var type1" id="S5T12U617">stillness</span>(<span class="var type1" id="S47T3U618">k</span>)</span> = <span class="mxinfo " id="T3:U205">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">%     disp('stillness:');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="comment">%     disp(size(stillness));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="comment">%     disp(class(stillness));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="comment">%     </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="keyword">if</span>(strcmp(<span class="var type1" id="S55T13U625">state</span>,<span class="string">'active'</span>))</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">        [<span class="var type1" id="S69T3U630">delta_w</span>,<span class="var type1" id="S70T3U631">cost</span>]  = <span class="fcn" id="F302N6:B633">delta_est_window</span>(<span class="mxinfo " id="T5:U209"><span class="mxinfo " id="T5:U210"><span class="var type1" id="S7T4U636">data1</span>.quat</span>(<span class="mxinfo " id="T12:U212"><span class="var type1" id="S51T3U640">startIndex</span>:<span class="var type1" id="S29T3U641">data_steps</span>:<span class="var type1" id="S52T3U642">endIndex</span></span>,<span class="mxinfo " id="T14:U216">:</span>)</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">            <span class="mxinfo " id="T5:U217"><span class="mxinfo " id="T5:U218"><span class="var type1" id="S8T4U646">data2</span>.quat</span>(<span class="mxinfo " id="T12:U220"><span class="var type1" id="S51T3U650">startIndex</span>:<span class="var type1" id="S29T3U651">data_steps</span>:<span class="var type1" id="S52T3U652">endIndex</span></span>,<span class="mxinfo " id="T14:U224">:</span>)</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">            <span class="var type1" id="S35T6U654">j</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">            <span class="var type1" id="S36T6U655">j_long</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">            <span class="var type1" id="S11T3U656">gnSteps</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">            <span class="var type1" id="S39T3U657">last_delta_w</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">            <span class="var type1" id="S19T8U658">constraint</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">        <span class="keyword">if</span>(<span class="var type1" id="S49T9U662">startup_estimation</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">            [<span class="var type1" id="S72T3U666">delta_w_180</span>,<span class="var type1" id="S73T3U667">cost_180</span>]  = <span class="fcn" id="F302N6:B669">delta_est_window</span>(<span class="mxinfo " id="T5:U233"><span class="mxinfo " id="T5:U234"><span class="var type1" id="S7T4U672">data1</span>.quat</span>(<span class="mxinfo " id="T12:U236"><span class="var type1" id="S51T3U676">startIndex</span>:<span class="var type1" id="S29T3U677">data_steps</span>:<span class="var type1" id="S52T3U678">endIndex</span></span>,<span class="mxinfo " id="T14:U240">:</span>)</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">                <span class="mxinfo " id="T5:U241"><span class="mxinfo " id="T5:U242"><span class="var type1" id="S8T4U682">data2</span>.quat</span>(<span class="mxinfo " id="T12:U244"><span class="var type1" id="S51T3U686">startIndex</span>:<span class="var type1" id="S29T3U687">data_steps</span>:<span class="var type1" id="S52T3U688">endIndex</span></span>,<span class="mxinfo " id="T14:U248">:</span>)</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">                <span class="var type1" id="S35T6U690">j</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">                <span class="var type1" id="S36T6U691">j_long</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">                <span class="var type1" id="S11T3U692">gnSteps</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">                <span class="mxinfo " id="T3:U252"><span class="var type1" id="S39T3U694">last_delta_w</span>+<span class="mxinfo " id="T3:U254">pi</span></span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">                <span class="var type1" id="S19T8U697">constraint</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">            <span class="keyword">if</span>(<span class="mxinfo " id="T9:U256"><span class="var type1" id="S73T3U702">cost_180</span> &lt; <span class="var type1" id="S70T3U703">cost</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">                <span class="mxinfo " id="T3:U259"><span class="var type1" id="S69T3U706">delta_w</span> = <span class="var type1" id="S72T3U707">delta_w_180</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo " id="T3:U262"><span class="var type1" id="S39T3U710">last_delta_w</span> = <span class="var type1" id="S69T3U711">delta_w</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">    <span class="mxinfo " id="T3:U265"><span class="mxinfo " id="T3:U266"><span class="var type1" id="S4T12U715">r_w</span>(<span class="var type1" id="S47T3U716">k</span>)</span> = <span class="mxinfo " id="T3:U269"><span class="fcn" id="F331N7:B718">getWindowWeight</span>(<span class="mxinfo " id="T5:U270"><span class="mxinfo " id="T5:U271"><span class="var type1" id="S7T4U721">data1</span>.quat</span>(<span class="mxinfo " id="T12:U273"><span class="var type1" id="S51T3U725">startIndex</span>:<span class="var type1" id="S29T3U726">data_steps</span>:<span class="var type1" id="S52T3U727">endIndex</span></span>,<span class="mxinfo " id="T14:U277">:</span>)</span>,<span class="mxinfo " id="T5:U278"><span class="mxinfo " id="T5:U279"><span class="var type1" id="S8T4U731">data2</span>.quat</span>(<span class="mxinfo " id="T12:U281"><span class="var type1" id="S51T3U735">startIndex</span>:<span class="var type1" id="S29T3U736">data_steps</span>:<span class="var type1" id="S52T3U737">endIndex</span></span>,<span class="mxinfo " id="T14:U285">:</span>)</span>,<span class="var type1" id="S35T6U739">j</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line"><span class="comment">%     disp('r_w:');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="comment">%     disp(size(r_w));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">%     disp(class(r_w));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    <span class="keyword">if</span>(<span class="var type1" id="S49T9U743">startup_estimation</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">        <span class="mxinfo " id="T3:U288"><span class="mxinfo " id="T3:U289"><span class="var type1" id="S44T12U747">r_w_mod</span>(<span class="var type1" id="S47T3U748">k</span>)</span> = <span class="mxinfo " id="T3:U292">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="mxinfo " id="T3:U293"><span class="mxinfo " id="T3:U294"><span class="var type1" id="S45T12U753">tauDelta_mod</span>(<span class="var type1" id="S47T3U754">k</span>)</span> = <span class="mxinfo " id="T3:U297">0.8</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">        <span class="mxinfo " id="T3:U298"><span class="mxinfo " id="T3:U299"><span class="var type1" id="S46T12U759">tauBias_mod</span>(<span class="var type1" id="S47T3U760">k</span>)</span> = <span class="mxinfo " id="T3:U302">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">        <span class="mxinfo " id="T3:U303"><span class="mxinfo " id="T3:U304"><span class="var type1" id="S44T12U766">r_w_mod</span>(<span class="var type1" id="S47T3U767">k</span>)</span> = <span class="mxinfo " id="T3:U307"><span class="var type1" id="S4T12U769">r_w</span>(<span class="var type1" id="S47T3U770">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">        <span class="mxinfo " id="T3:U310"><span class="mxinfo " id="T3:U311"><span class="var type1" id="S46T12U774">tauBias_mod</span>(<span class="var type1" id="S47T3U775">k</span>)</span> = <span class="var type1" id="S16T3U776">tauBias</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">        <span class="mxinfo " id="T3:U315"><span class="mxinfo " id="T3:U316"><span class="var type1" id="S45T12U780">tauDelta_mod</span>(<span class="var type1" id="S47T3U781">k</span>)</span> = <span class="var type1" id="S15T3U782">tauDelta</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">    <span class="keyword">if</span>(strcmp(<span class="var type1" id="S55T13U788">state</span>,<span class="string">'stillness'</span>))</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">        <span class="var type0" id="S44T0U793">r_w_mod</span>(<span class="var type0" id="S47T0U794">k</span>) = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T3:U321"><span class="mxinfo " id="T3:U322"><span class="var type1" id="S2T12U799">delta</span>(<span class="var type1" id="S47T3U800">k</span>)</span> = <span class="var type1" id="S69T3U801">delta_w</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">%     disp('r_w_mod:');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="comment">%     disp(size(r_w_mod));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"><span class="comment">%     disp(class(r_w_mod));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="comment">%     disp('tauDelta_mod:');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">%     disp(size(tauDelta_mod));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"><span class="comment">%     disp(class(tauDelta_mod));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"><span class="comment">%     disp('tauBias_mod:');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line"><span class="comment">%     disp(size(tauBias_mod));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line"><span class="comment">%     disp(class(tauBias_mod));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line"><span class="comment">%     disp('delta:');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line"><span class="comment">%     disp(size(delta));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line"><span class="comment">%     disp(class(delta));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"><span class="comment">% Cut the arrays to the right length</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line"><span class="keyword">if</span>(strcmp(<span class="var type1" id="S18T8U807">alignment</span>,<span class="string">'backward'</span>))</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="mxinfo " id="T1:U327"><span class="var type1" id="S3T1U811">delta_filt</span>      = <span class="mxinfo " id="T1:U329"><span class="fcn" id="F404N17:B813">headingFilter_extrap</span>(<span class="mxinfo " id="T12:U330">unwrap(<span class="var type1" id="S2T12U816">delta</span>)</span>,<span class="var type1" id="S44T12U817">r_w_mod</span>,<span class="var type1" id="S14T3U818">estimation_rate</span>,<span class="var type1" id="S45T12U819">tauDelta_mod</span>,<span class="var type1" id="S46T12U820">tauBias_mod</span>,<span class="var type1" id="S17T3U821">minWeight</span>,<span class="var type1" id="S12T3U822">window_time</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="var type0" id="S3T0U826">delta_filt</span>      = headingFilter(unwrap(<span class="var type0" id="S2T0U831">delta</span>),<span class="var type0" id="S44T0U832">r_w_mod</span>,<span class="var type0" id="S14T0U833">estimation_rate</span>,<span class="var type0" id="S45T0U834">tauDelta_mod</span>,<span class="var type0" id="S46T0U835">tauBias_mod</span>,<span class="var type0" id="S17T0U836">minWeight</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="mxinfo " id="T1:U338"><span class="var type1" id="S2T1U839">delta</span>           = <span class="mxinfo " id="T1:U340">interp1(<span class="mxinfo " id="T1:U341"><span class="mxinfo " id="T1:U342"><span class="var type1" id="S7T4U844">data1</span>.time</span>(<span class="var type1" id="S40T12U846">starts</span>)</span>,<span class="mxinfo " id="T12:U345">unwrap(<span class="var type1" id="S2T12U849">delta</span>)</span>,<span class="mxinfo " id="T1:U347"><span class="var type1" id="S7T4U851">data1</span>.time</span>,<span class="string">'linear'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"><span class="mxinfo " id="T1:U349"><span class="var type1" id="S3T1U856">delta_filt</span>      = <span class="mxinfo " id="T1:U351">interp1(<span class="mxinfo " id="T1:U352"><span class="mxinfo " id="T1:U353"><span class="var type1" id="S7T4U861">data1</span>.time</span>(<span class="var type1" id="S40T12U863">starts</span>)</span>,<span class="var type1" id="S3T1U864">delta_filt</span>,<span class="mxinfo " id="T1:U357"><span class="var type1" id="S7T4U866">data1</span>.time</span>,<span class="string">'linear'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line"><span class="mxinfo " id="T1:U359"><span class="var type1" id="S4T1U871">r_w</span>             = <span class="mxinfo " id="T1:U361">interp1(<span class="mxinfo " id="T1:U362"><span class="mxinfo " id="T1:U363"><span class="var type1" id="S7T4U876">data1</span>.time</span>(<span class="var type1" id="S40T12U878">starts</span>)</span>,<span class="var type1" id="S4T12U879">r_w</span>,<span class="mxinfo " id="T1:U367"><span class="var type1" id="S7T4U881">data1</span>.time</span>,<span class="string">'linear'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"><span class="mxinfo " id="T1:U369"><span class="var type1" id="S5T1U886">stillness</span>       = <span class="mxinfo " id="T1:U371">interp1(<span class="mxinfo " id="T1:U372"><span class="mxinfo " id="T1:U373"><span class="var type1" id="S7T4U891">data1</span>.time</span>(<span class="var type1" id="S40T12U893">starts</span>)</span>,<span class="var type1" id="S5T12U894">stillness</span>,<span class="mxinfo " id="T1:U377"><span class="var type1" id="S7T4U896">data1</span>.time</span>,<span class="string">'linear'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">%% delta_est_window</span></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">function [delta,cost] = delta_est_window(q1,q2,j,j_long,gnSteps,startVal,constraint)</span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">delta = startVal;</span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">for i = 1:gnSteps</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    [deltaParams,cost]  = gnStep(j,j_long,q1,q2,delta,constraint);</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">    delta               = delta + deltaParams;</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">delta = limitHeading(delta);</span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"><span class="comment">%% gnStep</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line">function [deltaParams,totalError] = gnStep(j,j_long,q1,q2,delta,constraint)</span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line">[errors,jacobi] = getErrorAndJac_1D(q1,q2,j,j_long,delta,constraint);</span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">deltaParams = -(mldivide((jacobi'*jacobi),jacobi'*errors));</span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line">totalError = norm(errors);</span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"><span class="comment">%% getWindowWeight</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line">function out = getWindowWeight(q1,q2,j)</span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line">v1 = quaternionRotate(q1,j);</span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line">v2 = quaternionRotate(q2,j);</span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line">weight = sqrt(v1(:,1).^2 + v1(:,2).^2) .* sqrt(v2(:,1).^2 + v2(:,2).^2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line">out = rms(weight);</span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
